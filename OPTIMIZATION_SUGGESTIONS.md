# cf-doh é¡¹ç›®ä¼˜åŒ–å»ºè®®æ±‡æ€»

æœ¬æ–‡æ¡£æ±‡æ€»äº† cf-doh (Country-Aware DNS over HTTPS Worker) é¡¹ç›®çš„æ‰€æœ‰ä¼˜åŒ–å»ºè®®ï¼Œåˆ†ä¸º**ä»£ç è´¨é‡ä¼˜åŒ–**å’Œ**åŠŸèƒ½å¢å¼º**ä¸¤å¤§ç±»ã€‚

---

## ä¸€ã€ä»£ç è´¨é‡ä¼˜åŒ–

### ğŸ”´ é«˜ä¼˜å…ˆçº§

| #   | é—®é¢˜                  | ä½ç½®                 | å»ºè®®                                             |
| --- | --------------------- | -------------------- | ------------------------------------------------ |
| 1   | **é”™è¯¯å¤„ç†ä¸å®Œå–„**    | `workers.js:62-63`   | `atob()` è§£ç å¤±è´¥æ—¶æ·»åŠ  try-catchï¼Œè¿”å› 400 å“åº” |
| 2   | **IPv6 è§£æè¾¹ç•Œæƒ…å†µ** | `workers.js:230-250` | `ipv6ToBytes()` éœ€å¤„ç†å¤šä¸ªè¿ç»­ `::` çš„æƒ…å†µ       |
| 3   | **è¾“å…¥éªŒè¯**          | `workers.js:315-328` | åœ¨ SQL æŸ¥è¯¢å‰éªŒè¯ IP æ ¼å¼æœ‰æ•ˆæ€§                  |

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

| #   | é—®é¢˜                 | ä½ç½®                 | å»ºè®®                                                      |
| --- | -------------------- | -------------------- | --------------------------------------------------------- |
| 4   | **LRU ç¼“å­˜ç­–ç•¥ç²—ç³™** | `workers.js:304-311` | ä¸€æ¬¡åˆ é™¤ 50% ç¼“å­˜æ€§èƒ½æŠ–åŠ¨å¤§ï¼Œæ”¹ç”¨å¹³æ»‘æ·˜æ±°                 |
| 5   | **ç¡¬ç¼–ç é…ç½®**       | `workers.js`         | `MEM_CACHE_MAX_SIZE`, `CACHE_TTL_SECONDS` æ”¹ä¸º `env` å˜é‡ |
| 6   | **æœªä½¿ç”¨çš„å˜é‡**     | `workers.js:397-402` | `flags`, `nsCount`, `arCount` è§£æåæœªä½¿ç”¨                |
| 7   | **è¿‡å¤šæ—¥å¿—**         | `workers.js`         | æ·»åŠ  `DEBUG` ç¯å¢ƒå˜é‡æ§åˆ¶ `console.log`                   |

### ğŸŸ¢ ä½ä¼˜å…ˆçº§

| #   | é—®é¢˜                | ä½ç½®                                         | å»ºè®®                             |
| --- | ------------------- | -------------------------------------------- | -------------------------------- |
| 8   | **Python å†…å­˜ä¼˜åŒ–** | `extract_mmdb.py`                            | ä½¿ç”¨ç”Ÿæˆå™¨å‡å°‘å†…å­˜å ç”¨           |
| 9   | **CI ç¼“å­˜ç¼ºå¤±**     | `deploy.yml`                                 | æ·»åŠ  npm/pip ç¼“å­˜åŠ é€Ÿæ„å»º        |
| 10  | **æ­»ä»£ç **          | `merge.sql`, `merge_non_target_countries.py` | æœªè¢« CI ä½¿ç”¨ï¼Œè€ƒè™‘åˆ é™¤æˆ–æ·»åŠ è¯´æ˜ |
| 11  | **ç±»å‹å®‰å…¨**        | `workers.js`                                 | è€ƒè™‘è¿ç§»åˆ° TypeScript            |

---

## äºŒã€åŠŸèƒ½å¢å¼º

### â­â­â­ é«˜ä»·å€¼åŠŸèƒ½

#### 1. DNS å“åº”ç¼“å­˜

- **ç°çŠ¶**ï¼šåªç¼“å­˜ IPâ†’ å›½å®¶æ˜ å°„ï¼Œä¸ç¼“å­˜ DNS å“åº”æœ¬èº«
- **ä¼˜åŒ–**ï¼šç¼“å­˜å®Œæ•´ DNS å“åº”ï¼Œå‡å°‘ä¸Šæ¸¸æŸ¥è¯¢æ¬¡æ•°
- **æ•ˆæœ**ï¼šé™ä½å»¶è¿Ÿã€å‡å°‘ä¸Šæ¸¸ä¾èµ–

#### 2. JSON DNS API

- **ç°çŠ¶**ï¼šä»…æ”¯æŒ RFC 8484 äºŒè¿›åˆ¶æ ¼å¼
- **ä¼˜åŒ–**ï¼šæ·»åŠ  JSON API ç«¯ç‚¹

```text
GET /resolve?name=example.com&type=A
â†’ {"Answer":[{"name":"example.com","data":"93.184.216.34","TTL":300}]}
```

- **æ•ˆæœ**ï¼šæ›´æ˜“è°ƒè¯•ã€æµè§ˆå™¨ç›´æ¥å¯ç”¨

#### 3. è®¿é—®æ§åˆ¶

- **ç°çŠ¶**ï¼šæ— ä»»ä½•è®¿é—®é™åˆ¶
- **å¯æ·»åŠ **ï¼šAPI Key è®¤è¯ã€IP ç™½åå•ã€è¯·æ±‚é™æµ

---

### â­â­ ä¸­ç­‰ä»·å€¼åŠŸèƒ½

#### 4. ç›‘æ§ç»Ÿè®¡ API

```text
GET /stats   â†’ ç¼“å­˜å‘½ä¸­ç‡ã€æŸ¥è¯¢è®¡æ•°ã€å»¶è¿Ÿåˆ†å¸ƒ
GET /health  â†’ å¥åº·æ£€æŸ¥
GET /debug/ip/:ip â†’ IP å›½å®¶è§£æè°ƒè¯•
```

#### 5. åˆ†æµè§„åˆ™å¼•æ“

```javascript
const RULES = [
	{ match: { domain: '*.google.com' }, action: 'use_alternative_ip' },
	{ match: { domain: '*.cn' }, action: 'use_client_ip' },
	{ match: { country: 'CN', type: 'AAAA' }, action: 'drop' },
];
```

#### 6. ä¸Šæ¸¸ DNS ç®¡ç†

- å¯é…ç½®å¤šä¸Šæ¸¸ (é˜¿é‡Œ DNSã€NextDNS ç­‰)
- æ”¯æŒåŠ æƒè½®è¯¢ã€å¥åº·æ£€æŸ¥
- æŒ‰åŸŸåé€‰æ‹©ä¸Šæ¸¸

#### 7. æ›´æ™ºèƒ½çš„è·¯ç”±

- å¤šå›½å®¶ä¼˜å…ˆçº§åˆ—è¡¨ `["CN", "HK", "TW", "JP"]`
- ASN/è¿è¥å•†åŒ¹é…
- CDN ä¸“ç”¨è§„åˆ™

---

### â­ æ‰©å±•åŠŸèƒ½

| åŠŸèƒ½                | æè¿°                          |
| ------------------- | ----------------------------- |
| **CNAME è®°å½•æ”¯æŒ**  | å½“å‰åªè§£æ A/AAAA             |
| **TTL åŠ¨æ€ç¼“å­˜**    | æ ¹æ® DNS TTL è®¾ç½®ç¼“å­˜æ—¶é—´     |
| **è´Ÿé¢ç¼“å­˜**        | ç¼“å­˜ NXDOMAIN ç»“æœ            |
| **DNSSEC éªŒè¯**     | éªŒè¯å“åº”ç­¾å                  |
| **CORS æ”¯æŒ**       | æµè§ˆå™¨ç›´æ¥è°ƒç”¨                |
| **å¢é‡ GeoIP æ›´æ–°** | åªåœ¨æ•°æ®å˜åŒ–æ—¶æ›´æ–°            |
| **ç®€åŒ– URL æ ¼å¼**   | æ”¯æŒ `/dns-query?alt=x.x.x.x` |

---

## ä¸‰ã€å®æ–½ä¼˜å…ˆçº§å»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼šç¨³å®šæ€§ (1-2 å¤©)

- [x] é”™è¯¯å¤„ç†å®Œå–„
- [x] è¾“å…¥éªŒè¯
- [x] é…ç½®å¤–éƒ¨åŒ–

### ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ (2-3 å¤©)

- [ ] DNS å“åº”ç¼“å­˜
- [ ] æ—¥å¿—æ§åˆ¶
- [ ] LRU ç¼“å­˜ä¼˜åŒ–

### ç¬¬ä¸‰é˜¶æ®µï¼šåŠŸèƒ½ (1 å‘¨)

- [ ] JSON DNS API
- [ ] ç»Ÿè®¡ API
- [ ] è®¿é—®æ§åˆ¶

### ç¬¬å››é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½ (æŒ‰éœ€)

- [ ] è§„åˆ™å¼•æ“
- [ ] ä¸Šæ¸¸ç®¡ç†
- [ ] æ™ºèƒ½è·¯ç”±

---

## å››ã€å¿«é€Ÿä»£ç ä¿®å¤ç¤ºä¾‹

### 1. é”™è¯¯å¤„ç†æ”¹è¿›

```javascript
// workers.js ç¬¬ 57-69 è¡Œæ›¿æ¢ä¸º
if (request.method === 'GET') {
	const dnsParam = url.searchParams.get('dns');
	if (!dnsParam) {
		return new Response('Missing dns parameter', { status: 400 });
	}
	try {
		const decodedQuery = atob(dnsParam);
		queryData = Uint8Array.from(decodedQuery, (c) => c.codePointAt(0));
	} catch {
		return new Response('Invalid dns parameter encoding', { status: 400 });
	}
}
```

### 2. é…ç½®å¤–éƒ¨åŒ–

```javascript
// workers.js å¼€å¤´
const MEM_CACHE_MAX_SIZE = env.MEM_CACHE_MAX_SIZE ?? 10000;
const CACHE_TTL_SECONDS = env.CACHE_TTL_SECONDS ?? 86400;
const DEBUG = env.DEBUG === 'true';

// æ—¥å¿—å‡½æ•°
const log = (...args) => DEBUG && console.log(...args);
```

### 3. IP æ ¼å¼éªŒè¯

```javascript
function isValidIP(ip) {
	return isIPv4(ip) || isIPv6(ip);
}

// åœ¨ ip2country å¼€å¤´æ·»åŠ 
if (!isValidIP(ip)) return null;
```

---

## äº”ã€å‚è€ƒèµ„æº

- [Cloudflare Workers æ–‡æ¡£](https://developers.cloudflare.com/workers/)
- [RFC 8484 - DNS over HTTPS](https://datatracker.ietf.org/doc/html/rfc8484)
- [Google JSON DNS API](https://developers.google.com/speed/public-dns/docs/doh/json)
